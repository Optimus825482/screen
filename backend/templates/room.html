{% extends "base.html" %} {% block title %}Oda - ScreenShare Pro{% endblock %}
{% block head %}
<style>
  .video-container {
    background: linear-gradient(135deg, #1a2430 0%, #101822 100%);
  }
  .control-btn {
    @apply p-3 rounded-lg transition-colors;
  }
  .control-btn:hover {
    @apply bg-white/10;
  }
  .control-btn.active {
    @apply bg-primary text-white;
  }
  .control-btn.danger {
    @apply bg-red-500 hover:bg-red-600;
  }
  /* Whiteboard Styles */
  .whiteboard-canvas {
    touch-action: none;
    cursor: crosshair;
  }
  .color-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid transparent;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .color-btn.active {
    border-color: white;
    transform: scale(1.15);
  }
  .tool-btn {
    padding: 6px;
    border-radius: 6px;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .tool-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  .tool-btn.active {
    background: rgba(19, 109, 236, 0.3);
    color: #136dec;
  }
  /* Mobile whiteboard toolbar */
  @media (max-width: 640px) {
    .color-btn {
      width: 20px;
      height: 20px;
    }
    .tool-btn {
      padding: 4px;
    }
    .whiteboard-toolbar {
      flex-wrap: wrap;
      gap: 4px !important;
      padding: 6px !important;
    }
    .whiteboard-toolbar .divider {
      display: none;
    }
  }
</style>
{% endblock %} {% block content %}
<div
  x-data="roomPage()"
  x-init="init()"
  x-cloak
  class="min-h-screen flex flex-col bg-background-dark"
>
  <!-- Header -->
  <header
    class="h-14 md:h-16 flex items-center justify-between px-3 md:px-6 border-b border-border-dark bg-background-dark shrink-0 z-10 safe-area-top"
  >
    <div class="flex items-center gap-2 md:gap-4 text-white">
      <button
        @click="leaveRoom()"
        class="p-2 hover:bg-surface-dark rounded-lg transition-colors"
      >
        <span class="material-symbols-outlined text-[22px] md:text-[24px]"
          >arrow_back</span
        >
      </button>
      <h2
        class="text-sm md:text-lg font-bold leading-tight tracking-[-0.015em] truncate max-w-[100px] md:max-w-none"
        x-text="roomName"
      ></h2>
    </div>

    <!-- Invite Link (Center) - Hidden on mobile -->
    <div class="hidden sm:flex flex-1 justify-center">
      <div
        class="flex items-center gap-2 bg-surface-dark px-3 py-1.5 rounded-lg border border-border-dark max-w-md"
      >
        <span class="material-symbols-outlined text-primary text-[18px]"
          >link</span
        >
        <span
          class="text-xs text-text-secondary truncate max-w-[200px] md:max-w-[300px] select-all"
          x-text="getInviteLink()"
        ></span>
        <button
          @click="copyInviteLinkHeader()"
          class="p-1.5 hover:bg-surface-hover rounded-md transition-colors group"
          title="Linki Kopyala"
        >
          <span
            class="material-symbols-outlined text-[16px] text-text-secondary group-hover:text-primary transition-colors"
            x-text="linkCopied ? 'check' : 'content_copy'"
            :class="linkCopied ? 'text-green-500' : ''"
          ></span>
        </button>
      </div>
    </div>

    <div class="flex items-center gap-2 md:gap-4">
      <!-- Recording Timer -->
      <div
        x-show="isScreenSharing || isCameraSharing"
        class="flex items-center gap-1.5 md:gap-2 bg-surface-dark px-2 md:px-3 py-1 md:py-1.5 rounded-lg border border-border-dark"
      >
        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
        <span
          class="text-[10px] md:text-xs font-mono font-medium text-text-secondary"
          x-text="formatTime(elapsedTime)"
        ></span>
      </div>
      <!-- Connection Status -->
      <div
        class="flex items-center gap-2 bg-surface-dark px-2 md:px-3 py-1 md:py-1.5 rounded-lg border border-border-dark"
      >
        <span
          class="material-symbols-outlined text-[16px] md:text-[18px]"
          :class="connected ? 'text-green-500' : 'text-red-500'"
          x-text="connected ? 'signal_cellular_alt' : 'signal_cellular_off'"
        ></span>
      </div>
      <!-- Mobile Sidebar Toggle -->
      <button
        @click="showMobileSidebar = !showMobileSidebar"
        class="lg:hidden p-2 hover:bg-surface-dark rounded-lg transition-colors relative"
      >
        <span class="material-symbols-outlined text-[22px]">chat</span>
        <span
          x-show="chatMessages.length > 0 && !showMobileSidebar"
          class="absolute top-1 right-1 w-2 h-2 bg-primary rounded-full"
        ></span>
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Main Video Area -->
    <main
      class="flex-1 flex flex-col relative bg-black/20 p-2 md:p-4 gap-2 md:gap-4"
    >
      <!-- Screen Share Area -->
      <div
        class="flex-1 flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-border-dark video-container relative overflow-hidden"
      >
        <!-- Whiteboard Canvas (paylaşım yokken) -->
        <canvas
          x-ref="whiteboardCanvas"
          x-show="showWhiteboard && !isScreenSharing && !isCameraSharing && !remoteStream"
          @mousedown="startDrawing($event)"
          @mousemove="draw($event)"
          @mouseup="stopDrawing()"
          @mouseleave="stopDrawing()"
          @touchstart.prevent="startDrawing($event)"
          @touchmove.prevent="draw($event)"
          @touchend="stopDrawing()"
          class="whiteboard-canvas absolute inset-0 w-full h-full z-20"
        ></canvas>

        <!-- Remote Video (for viewers) -->
        <video
          x-ref="remoteVideo"
          x-show="!isHost && remoteStream"
          autoplay
          playsinline
          class="w-full h-full object-contain"
        ></video>

        <!-- Local Video Preview (for host) -->
        <video
          x-ref="localVideo"
          x-show="isHost && (isScreenSharing || isCameraSharing)"
          autoplay
          playsinline
          muted
          class="w-full h-full object-contain"
          :class="isCameraSharing ? 'scale-x-[-1]' : ''"
        ></video>

        <!-- Waiting State - Kimse paylaşmıyor -->
        <div
          x-show="!isScreenSharing && !isCameraSharing && !currentPresenterId && !showWhiteboard"
          class="relative z-10 flex flex-col items-center gap-6 p-8 rounded-2xl bg-surface-dark/90 shadow-2xl backdrop-blur-md max-w-md text-center border border-border-dark"
        >
          <div
            class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center"
          >
            <span
              class="material-symbols-outlined text-primary text-[32px]"
              x-text="isMobile ? 'videocam' : 'present_to_all'"
            ></span>
          </div>
          <div class="space-y-2">
            <h3
              class="text-xl font-bold text-white"
              x-text="isMobile ? 'Kamera veya Ekran Paylaş' : 'Ekran Paylaşımı Başlat'"
            ></h3>
            <p
              class="text-sm text-text-secondary"
              x-text="isMobile ? 'Kameranızı veya ekranınızı paylaşmak için aşağıdaki butona tıklayın.' : 'Ekranınızı paylaşmak için aşağıdaki butona tıklayın.'"
            ></p>
          </div>

          <!-- Mobil için butonlar -->
          <template x-if="isMobile">
            <div class="flex flex-col gap-3 w-full">
              <button
                @click="startCameraShare()"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-lg transition-colors font-medium"
              >
                <span class="material-symbols-outlined">videocam</span>
                Kamera Paylaş
              </button>
              <button
                @click="startScreenShare()"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-surface-hover hover:bg-border-dark text-white rounded-lg transition-colors font-medium border border-border-dark"
              >
                <span class="material-symbols-outlined">screen_share</span>
                Ekran Paylaş (Beta)
              </button>
              <button
                @click="toggleWhiteboard()"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors font-medium"
              >
                <span class="material-symbols-outlined">draw</span>
                Whiteboard Aç
              </button>
            </div>
          </template>

          <!-- Desktop için butonlar -->
          <template x-if="!isMobile">
            <div class="flex flex-col gap-3 w-full">
              <button
                @click="startScreenShare()"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-lg transition-colors font-medium"
              >
                <span class="material-symbols-outlined">screen_share</span>
                Ekran Paylaş
              </button>
              <button
                @click="toggleWhiteboard()"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors font-medium"
              >
                <span class="material-symbols-outlined">draw</span>
                Whiteboard Aç
              </button>
            </div>
          </template>
        </div>

        <!-- Whiteboard Active State -->
        <div
          x-show="showWhiteboard && !isScreenSharing && !isCameraSharing && !remoteStream"
          class="absolute top-2 sm:top-4 left-2 sm:left-4 right-2 sm:right-4 z-30 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2"
        >
          <!-- Whiteboard Tools -->
          <div
            class="whiteboard-toolbar flex items-center gap-1 sm:gap-2 bg-surface-dark/95 backdrop-blur-md border border-border-dark rounded-lg sm:rounded-xl p-1.5 sm:p-2 shadow-lg overflow-x-auto max-w-full"
          >
            <!-- Colors -->
            <div class="flex items-center gap-0.5 sm:gap-1 px-1 sm:px-2">
              <template x-for="color in whiteboardColors" :key="color">
                <button
                  @click="currentColor = color"
                  class="color-btn"
                  :class="currentColor === color ? 'active' : ''"
                  :style="'background-color: ' + color"
                ></button>
              </template>
            </div>
            <div class="divider w-px h-5 sm:h-6 bg-border-dark"></div>
            <!-- Brush Size -->
            <div class="flex items-center gap-0.5 sm:gap-1 px-1 sm:px-2">
              <button
                @click="brushSize = 2"
                class="tool-btn"
                :class="brushSize === 2 ? 'active' : ''"
              >
                <div class="w-1 h-1 bg-current rounded-full mx-auto"></div>
              </button>
              <button
                @click="brushSize = 5"
                class="tool-btn"
                :class="brushSize === 5 ? 'active' : ''"
              >
                <div
                  class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-current rounded-full mx-auto"
                ></div>
              </button>
              <button
                @click="brushSize = 10"
                class="tool-btn"
                :class="brushSize === 10 ? 'active' : ''"
              >
                <div
                  class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-current rounded-full mx-auto"
                ></div>
              </button>
            </div>
            <div class="divider w-px h-5 sm:h-6 bg-border-dark"></div>
            <!-- Tools -->
            <button
              @click="isEraser = false"
              class="tool-btn"
              :class="!isEraser ? 'active' : ''"
              title="Kalem"
            >
              <span class="material-symbols-outlined text-[18px] sm:text-[20px]"
                >edit</span
              >
            </button>
            <button
              @click="isEraser = true"
              class="tool-btn"
              :class="isEraser ? 'active' : ''"
              title="Silgi"
            >
              <span class="material-symbols-outlined text-[18px] sm:text-[20px]"
                >ink_eraser</span
              >
            </button>
            <button
              @click="clearCanvas()"
              class="tool-btn text-red-400"
              title="Temizle"
            >
              <span class="material-symbols-outlined text-[18px] sm:text-[20px]"
                >delete</span
              >
            </button>
          </div>
          <!-- Close Whiteboard -->
          <button
            @click="toggleWhiteboard()"
            class="flex items-center gap-1 sm:gap-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 px-2 sm:px-4 py-1.5 sm:py-2 rounded-lg transition-colors font-medium text-sm shrink-0"
          >
            <span class="material-symbols-outlined text-[16px] sm:text-[18px]"
              >close</span
            >
            <span class="hidden sm:inline">Kapat</span>
          </button>
        </div>

        <!-- Viewer Waiting - Başkası paylaşıyor -->
        <div
          x-show="!isScreenSharing && !isCameraSharing && currentPresenterId && !remoteStream"
          class="relative z-10 flex flex-col items-center gap-4 p-8 rounded-2xl bg-surface-dark/90 shadow-2xl backdrop-blur-md max-w-md text-center border border-border-dark"
        >
          <div
            class="w-16 h-16 rounded-full bg-blue-500/10 flex items-center justify-center"
          >
            <svg
              class="animate-spin h-8 w-8 text-primary"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </div>
          <div class="space-y-2">
            <h3 class="text-xl font-bold text-white">Bağlanıyor...</h3>
            <p class="text-sm text-text-secondary">
              <span x-text="currentPresenterName"></span>
              <span
                x-text="currentShareType === 'camera' ? 'kamera' : 'ekran'"
              ></span>
              paylaşıyor, bağlantı kuruluyor.
            </p>
          </div>
        </div>

        <!-- Host Sharing Indicator -->
        <div
          x-show="isScreenSharing || isCameraSharing"
          class="absolute top-6 z-10"
        >
          <div
            class="bg-surface-dark/80 backdrop-blur-md border border-white/10 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg"
          >
            <span
              class="material-symbols-outlined text-primary text-sm"
              x-text="isCameraSharing ? 'videocam' : 'screen_share'"
            ></span>
            <p
              class="text-slate-200 text-xs font-medium"
              x-text="isCameraSharing ? 'Kameranızı paylaşıyorsunuz' : 'Ekranınızı paylaşıyorsunuz'"
            ></p>
          </div>
        </div>

        <!-- Someone else sharing indicator -->
        <div
          x-show="!isScreenSharing && !isCameraSharing && currentPresenterId && remoteStream"
          class="absolute top-6 z-10"
        >
          <div
            class="bg-surface-dark/80 backdrop-blur-md border border-white/10 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg"
          >
            <span
              class="material-symbols-outlined text-green-400 text-sm"
              x-text="currentShareType === 'camera' ? 'videocam' : 'visibility'"
            ></span>
            <p class="text-slate-200 text-xs font-medium">
              <span x-text="currentPresenterName"></span>
              <span
                x-text="currentShareType === 'camera' ? 'kamera' : 'ekran'"
              ></span>
              paylaşıyor
            </p>
          </div>
        </div>
      </div>

      <!-- Control Bar -->
      <div class="flex justify-center pb-2 md:pb-4 safe-area-bottom">
        <div
          class="flex items-center gap-1 md:gap-2 bg-surface-dark border border-border-dark p-1.5 md:p-2 rounded-xl shadow-lg"
        >
          <!-- Mic Toggle -->
          <button
            @click="toggleMic()"
            class="control-btn relative p-2 md:p-3"
            :class="!isMuted ? 'text-white' : 'text-slate-400'"
            :title="isMuted ? 'Mikrofonu Aç' : 'Mikrofonu Kapat'"
          >
            <span
              x-show="!isMuted"
              class="absolute top-0.5 right-0.5 md:top-1 md:right-1 w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full border-2 border-surface-dark"
            ></span>
            <span
              class="material-symbols-outlined text-[20px] md:text-[24px]"
              x-text="isMuted ? 'mic_off' : 'mic'"
            ></span>
          </button>

          <div class="w-px h-6 md:h-8 bg-white/10 mx-0.5 md:mx-1"></div>

          <!-- Share Button with Menu -->
          <div class="relative" x-data="{ open: false }">
            <!-- Paylaşım Aktifken - Durdur Butonu -->
            <template x-if="isScreenSharing || isCameraSharing">
              <div class="flex items-center gap-1">
                <!-- Kamera değiştir (sadece kamera paylaşımında) -->
                <button
                  x-show="isCameraSharing"
                  @click="switchCamera()"
                  class="flex items-center gap-1 px-3 h-10 rounded-lg font-medium text-sm bg-surface-dark text-white hover:bg-surface-hover transition-all"
                  title="Kamera Değiştir"
                >
                  <span class="material-symbols-outlined text-[20px]"
                    >cameraswitch</span
                  >
                </button>
                <!-- Durdur -->
                <button
                  @click="stopSharing()"
                  class="flex items-center gap-2 px-4 h-10 rounded-lg font-medium text-sm bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-all"
                >
                  <span class="material-symbols-outlined text-[20px]"
                    >stop_screen_share</span
                  >
                  <span class="hidden sm:inline">Durdur</span>
                </button>
              </div>
            </template>

            <!-- Paylaşım Pasifken -->
            <template x-if="!isScreenSharing && !isCameraSharing">
              <!-- Başka biri paylaşıyorsa disabled -->
              <template x-if="currentPresenterId">
                <button
                  disabled
                  class="flex items-center gap-2 px-4 h-10 rounded-lg font-medium text-sm bg-surface-dark text-slate-500 cursor-not-allowed"
                >
                  <span class="material-symbols-outlined text-[20px]"
                    >screen_share</span
                  >
                  <span
                    class="hidden sm:inline"
                    x-text="currentPresenterName + ' paylaşıyor'"
                  ></span>
                </button>
              </template>

              <!-- Paylaşım yapılabilir -->
              <template x-if="!currentPresenterId">
                <div class="relative">
                  <!-- Mobil: Menü göster -->
                  <template x-if="isMobile">
                    <div>
                      <button
                        @click="showShareMenu = !showShareMenu"
                        class="flex items-center gap-2 px-4 h-10 rounded-lg font-medium text-sm bg-primary hover:bg-primary-hover text-white shadow-md shadow-primary/20 transition-all"
                      >
                        <span class="material-symbols-outlined text-[20px]"
                          >add</span
                        >
                        <span class="hidden sm:inline">Paylaş</span>
                        <span
                          class="material-symbols-outlined text-[16px]"
                          x-text="showShareMenu ? 'expand_less' : 'expand_more'"
                        ></span>
                      </button>

                      <!-- Dropdown Menu -->
                      <div
                        x-show="showShareMenu"
                        @click.away="showShareMenu = false"
                        x-transition:enter="transition ease-out duration-100"
                        x-transition:enter-start="transform opacity-0 scale-95"
                        x-transition:enter-end="transform opacity-100 scale-100"
                        x-transition:leave="transition ease-in duration-75"
                        x-transition:leave-start="transform opacity-100 scale-100"
                        x-transition:leave-end="transform opacity-0 scale-95"
                        class="absolute bottom-full left-0 mb-2 w-48 bg-surface-dark border border-border-dark rounded-lg shadow-xl overflow-hidden z-50"
                      >
                        <button
                          @click="startCameraShare(); showShareMenu = false"
                          class="w-full flex items-center gap-3 px-4 py-3 text-sm text-white hover:bg-surface-hover transition-colors"
                        >
                          <span class="material-symbols-outlined text-primary"
                            >videocam</span
                          >
                          <div class="text-left">
                            <div class="font-medium">Kamera Paylaş</div>
                            <div class="text-xs text-text-secondary">
                              Ön veya arka kamera
                            </div>
                          </div>
                        </button>
                        <div class="border-t border-border-dark"></div>
                        <button
                          @click="startScreenShare(); showShareMenu = false"
                          class="w-full flex items-center gap-3 px-4 py-3 text-sm text-white hover:bg-surface-hover transition-colors"
                        >
                          <span class="material-symbols-outlined text-blue-400"
                            >screen_share</span
                          >
                          <div class="text-left">
                            <div class="font-medium">Ekran Paylaş</div>
                            <div class="text-xs text-text-secondary">
                              Desteklenmeyebilir
                            </div>
                          </div>
                        </button>
                      </div>
                    </div>
                  </template>

                  <!-- Desktop: Direkt ekran paylaşımı -->
                  <template x-if="!isMobile">
                    <button
                      @click="startScreenShare()"
                      class="flex items-center gap-2 px-4 h-10 rounded-lg font-medium text-sm bg-primary hover:bg-primary-hover text-white shadow-md shadow-primary/20 transition-all"
                    >
                      <span class="material-symbols-outlined text-[20px]"
                        >screen_share</span
                      >
                      <span class="hidden sm:inline">Paylaş</span>
                    </button>
                  </template>
                </div>
              </template>
            </template>
          </div>

          <!-- More Options -->
          <button
            class="control-btn text-white p-2 md:p-3 hidden sm:block"
            title="Diğer Seçenekler"
          >
            <span class="material-symbols-outlined text-[20px] md:text-[24px]"
              >more_vert</span
            >
          </button>

          <!-- End Call / Leave -->
          <button
            @click="isHost ? endRoom() : leaveRoom()"
            class="control-btn danger text-white ml-1 md:ml-2 shadow-md shadow-red-500/20 p-2 md:p-3"
            :title="isHost ? 'Odayı Sonlandır' : 'Odadan Ayrıl'"
          >
            <span class="material-symbols-outlined text-[20px] md:text-[24px]"
              >call_end</span
            >
          </button>
        </div>
      </div>
    </main>

    <!-- Desktop Sidebar -->
    <aside
      class="w-80 border-l border-border-dark bg-background-dark flex flex-col shrink-0 hidden lg:flex"
    >
      <!-- Tabs -->
      <div class="flex border-b border-border-dark">
        <button
          @click="activeTab = 'participants'"
          class="flex-1 py-4 text-sm font-medium border-b-2 transition-colors"
          :class="activeTab === 'participants' ? 'border-primary text-primary bg-primary/5' : 'border-transparent text-text-secondary hover:text-white hover:bg-surface-dark'"
        >
          Katılımcılar (<span x-text="participants.length"></span>)
        </button>
        <button
          @click="activeTab = 'chat'"
          class="flex-1 py-4 text-sm font-medium border-b-2 transition-colors"
          :class="activeTab === 'chat' ? 'border-primary text-primary bg-primary/5' : 'border-transparent text-text-secondary hover:text-white hover:bg-surface-dark'"
        >
          Sohbet
        </button>
      </div>

      <!-- Participants Tab -->
      <div
        x-show="activeTab === 'participants'"
        class="flex-1 overflow-y-auto p-4 space-y-4"
      >
        <!-- Invite Button (Host only) -->
        <template x-if="isHost">
          <div class="flex gap-2 mb-4">
            <button
              @click="copyInviteLink()"
              class="flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-lg bg-surface-dark text-xs font-semibold text-white hover:bg-surface-hover transition-colors border border-border-dark"
            >
              <span class="material-symbols-outlined text-[16px]"
                >person_add</span
              >
              Davet Et
            </button>
          </div>
        </template>

        <!-- Participant List -->
        <div class="space-y-2">
          <template
            x-for="participant in participants"
            :key="participant.user_id"
          >
            <div
              class="flex items-center gap-3 p-2 rounded-lg hover:bg-surface-dark transition-colors"
            >
              <div class="relative">
                <div
                  class="w-9 h-9 rounded-full bg-primary flex items-center justify-center text-white text-xs font-bold"
                >
                  <span
                    x-text="participant.username.charAt(0).toUpperCase()"
                  ></span>
                </div>
                <div
                  class="absolute -bottom-1 -right-1 bg-green-500 border-2 border-background-dark w-3.5 h-3.5 rounded-full"
                ></div>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-white truncate">
                  <span x-text="participant.username"></span>
                  <span
                    x-show="participant.user_id === currentUserId"
                    class="text-text-secondary"
                    >(Sen)</span
                  >
                </p>
                <p
                  x-show="participant.user_id === hostId"
                  class="text-xs text-primary"
                >
                  Sunucu
                </p>
              </div>
              <!-- Kick Button (Host only, not self) -->
              <template x-if="isHost && participant.user_id !== currentUserId">
                <button
                  @click="kickUser(participant.user_id)"
                  class="text-slate-400 hover:text-red-400 transition-colors"
                  title="Çıkar"
                >
                  <span class="material-symbols-outlined text-[18px]"
                    >person_remove</span
                  >
                </button>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Chat Tab -->
      <div x-show="activeTab === 'chat'" class="flex-1 flex flex-col">
        <!-- Messages -->
        <div x-ref="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-3">
          <template x-for="(msg, index) in chatMessages" :key="index">
            <div
              class="flex gap-3"
              :class="msg.user_id === currentUserId ? 'flex-row-reverse' : ''"
            >
              <div
                class="size-8 rounded-full flex items-center justify-center text-white text-xs font-bold shrink-0"
                :class="msg.user_id === currentUserId ? 'bg-primary' : 'bg-emerald-500'"
              >
                <span x-text="msg.username.charAt(0).toUpperCase()"></span>
              </div>
              <div
                class="flex flex-col gap-1 max-w-[85%]"
                :class="msg.user_id === currentUserId ? 'items-end' : ''"
              >
                <div
                  class="flex items-baseline gap-2"
                  :class="msg.user_id === currentUserId ? 'flex-row-reverse' : ''"
                >
                  <span
                    class="text-xs font-bold text-slate-200"
                    x-text="msg.username"
                  ></span>
                  <span
                    class="text-[10px] text-slate-400"
                    x-text="formatMessageTime(msg.timestamp)"
                  ></span>
                </div>
                <div
                  class="p-3 rounded-lg text-sm shadow-sm"
                  :class="msg.user_id === currentUserId ? 'bg-primary text-white rounded-tr-none' : 'bg-surface-hover text-slate-200 rounded-tl-none border border-border-dark'"
                >
                  <p x-text="msg.message"></p>
                </div>
              </div>
            </div>
          </template>
          <div
            x-show="chatMessages.length === 0"
            class="text-center text-slate-500 py-8"
          >
            <span class="material-symbols-outlined text-3xl mb-2 block"
              >chat</span
            >
            Henüz mesaj yok
          </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 bg-background-dark border-t border-border-dark">
          <form
            @submit.prevent="sendMessage"
            class="relative flex items-center"
          >
            <input
              x-model="newMessage"
              type="text"
              placeholder="Bir mesaj yazın..."
              class="w-full pl-4 pr-12 py-3 bg-surface-hover border border-border-dark rounded-xl text-sm text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
            />
            <button
              type="submit"
              class="absolute right-2 p-1.5 bg-primary hover:bg-primary-hover text-white rounded-lg transition-colors"
            >
              <span class="material-symbols-outlined text-[18px]">send</span>
            </button>
          </form>
        </div>
      </div>
    </aside>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div
    x-show="showMobileSidebar"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @click="showMobileSidebar = false"
    class="lg:hidden fixed inset-0 bg-black/60 z-40"
  ></div>

  <!-- Mobile Sidebar Panel -->
  <aside
    x-show="showMobileSidebar"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    class="lg:hidden fixed right-0 top-0 bottom-0 w-[85%] max-w-sm bg-background-dark border-l border-border-dark flex flex-col z-50 safe-area-top safe-area-bottom"
  >
    <!-- Mobile Sidebar Header -->
    <div
      class="flex items-center justify-between p-4 border-b border-border-dark"
    >
      <h3 class="font-bold text-white">Oda Detayları</h3>
      <button
        @click="showMobileSidebar = false"
        class="p-2 hover:bg-surface-dark rounded-lg"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Mobile Invite Link -->
    <div class="p-4 border-b border-border-dark">
      <button
        @click="copyInviteLink()"
        class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-surface-dark text-sm font-medium text-white hover:bg-surface-hover transition-colors border border-border-dark"
      >
        <span class="material-symbols-outlined text-primary text-[18px]"
          >link</span
        >
        Davet Linkini Kopyala
      </button>
    </div>

    <!-- Mobile Tabs -->
    <div class="flex border-b border-border-dark">
      <button
        @click="mobileTab = 'participants'"
        class="flex-1 py-3 text-sm font-medium border-b-2 transition-colors"
        :class="mobileTab === 'participants' ? 'border-primary text-primary bg-primary/5' : 'border-transparent text-text-secondary hover:text-white'"
      >
        Katılımcılar (<span x-text="participants.length"></span>)
      </button>
      <button
        @click="mobileTab = 'chat'"
        class="flex-1 py-3 text-sm font-medium border-b-2 transition-colors"
        :class="mobileTab === 'chat' ? 'border-primary text-primary bg-primary/5' : 'border-transparent text-text-secondary hover:text-white'"
      >
        Sohbet
      </button>
    </div>

    <!-- Mobile Participants -->
    <div
      x-show="mobileTab === 'participants'"
      class="flex-1 overflow-y-auto p-4 space-y-2"
    >
      <template x-for="participant in participants" :key="participant.user_id">
        <div
          class="flex items-center gap-3 p-2 rounded-lg hover:bg-surface-dark transition-colors"
        >
          <div class="relative">
            <div
              class="w-9 h-9 rounded-full bg-primary flex items-center justify-center text-white text-xs font-bold"
            >
              <span
                x-text="participant.username.charAt(0).toUpperCase()"
              ></span>
            </div>
            <div
              class="absolute -bottom-1 -right-1 bg-green-500 border-2 border-background-dark w-3 h-3 rounded-full"
            ></div>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-white truncate">
              <span x-text="participant.username"></span>
              <span
                x-show="participant.user_id === currentUserId"
                class="text-text-secondary"
                >(Sen)</span
              >
            </p>
            <p
              x-show="participant.user_id === hostId"
              class="text-xs text-primary"
            >
              Sunucu
            </p>
          </div>
          <template x-if="isHost && participant.user_id !== currentUserId">
            <button
              @click="kickUser(participant.user_id)"
              class="text-slate-400 hover:text-red-400 transition-colors p-2"
            >
              <span class="material-symbols-outlined text-[18px]"
                >person_remove</span
              >
            </button>
          </template>
        </div>
      </template>
    </div>

    <!-- Mobile Chat -->
    <div x-show="mobileTab === 'chat'" class="flex-1 flex flex-col">
      <div
        x-ref="mobileChatContainer"
        class="flex-1 overflow-y-auto p-4 space-y-3"
      >
        <template x-for="(msg, index) in chatMessages" :key="index">
          <div
            class="flex gap-2"
            :class="msg.user_id === currentUserId ? 'flex-row-reverse' : ''"
          >
            <div
              class="size-7 rounded-full flex items-center justify-center text-white text-xs font-bold shrink-0"
              :class="msg.user_id === currentUserId ? 'bg-primary' : 'bg-emerald-500'"
            >
              <span x-text="msg.username.charAt(0).toUpperCase()"></span>
            </div>
            <div
              class="flex flex-col gap-0.5 max-w-[80%]"
              :class="msg.user_id === currentUserId ? 'items-end' : ''"
            >
              <span
                class="text-[10px] text-slate-400"
                x-text="msg.username"
              ></span>
              <div
                class="p-2.5 rounded-lg text-sm"
                :class="msg.user_id === currentUserId ? 'bg-primary text-white rounded-tr-none' : 'bg-surface-hover text-slate-200 rounded-tl-none border border-border-dark'"
              >
                <p x-text="msg.message"></p>
              </div>
            </div>
          </div>
        </template>
        <div
          x-show="chatMessages.length === 0"
          class="text-center text-slate-500 py-8"
        >
          <span class="material-symbols-outlined text-3xl mb-2 block"
            >chat</span
          >
          Henüz mesaj yok
        </div>
      </div>
      <div class="p-3 bg-background-dark border-t border-border-dark">
        <form @submit.prevent="sendMessage" class="relative flex items-center">
          <input
            x-model="newMessage"
            type="text"
            placeholder="Mesaj yazın..."
            class="w-full pl-4 pr-12 py-2.5 bg-surface-hover border border-border-dark rounded-xl text-sm text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary/50"
          />
          <button
            type="submit"
            class="absolute right-2 p-1.5 bg-primary hover:bg-primary-hover text-white rounded-lg"
          >
            <span class="material-symbols-outlined text-[16px]">send</span>
          </button>
        </form>
      </div>
    </div>
  </aside>
</div>

<script src="/static/js/webrtc.js"></script>
<script>
  function roomPage() {
    return {
      roomId: "{{ room_id }}",
      publicUrl: "{{ public_url }}",
      roomName: "Yükleniyor...",
      inviteCode: "",
      hostId: "",
      currentUserId: "",
      isHost: false,
      connected: false,
      isScreenSharing: false,
      isCameraSharing: false,
      isMuted: true,
      remoteStream: null,
      participants: [],
      chatMessages: [],
      newMessage: "",
      activeTab: "participants",
      mobileTab: "participants",
      showMobileSidebar: false,
      elapsedTime: 0,
      timerInterval: null,
      webrtc: null,
      linkCopied: false,
      currentPresenterId: null,
      currentPresenterName: null,
      currentShareType: null,
      isMobile: false,
      showShareMenu: false,
      // Whiteboard
      showWhiteboard: false,
      isDrawing: false,
      currentColor: "#ffffff",
      brushSize: 5,
      isEraser: false,
      whiteboardColors: [
        "#ffffff",
        "#ef4444",
        "#22c55e",
        "#3b82f6",
        "#eab308",
        "#a855f7",
        "#ec4899",
      ],
      ctx: null,
      lastX: 0,
      lastY: 0,
      // Chat notification sound
      notificationSound: null,
      soundEnabled: true,

      // Ekran paylaşabilir miyim?
      canShare() {
        return (
          !this.currentPresenterId ||
          this.isScreenSharing ||
          this.isCameraSharing
        );
      },

      getInviteLink() {
        return this.publicUrl + "/join/" + this.inviteCode;
      },

      copyInviteLinkHeader() {
        const link = this.getInviteLink();
        navigator.clipboard.writeText(link);
        this.linkCopied = true;
        setTimeout(() => {
          this.linkCopied = false;
        }, 2000);
      },

      async init() {
        if (!Auth.requireAuth()) return;

        const user = Auth.getUser();
        this.currentUserId = user?.id;

        // Mobil cihaz kontrolü
        this.isMobile = WebRTCManager.isMobileDevice();

        // Ses bildirimi oluştur (Base64 encoded beep sound)
        this.createNotificationSound();

        // Load room info
        await this.loadRoomInfo();

        // Initialize WebRTC
        this.webrtc = new WebRTCManager(this.roomId, this.isHost);

        this.webrtc.onParticipantUpdate = (participants, data) => {
          const oldCount = this.participants.length;
          this.participants = participants;
          if (data.room_name) this.roomName = data.room_name;
          if (data.host_id) this.hostId = data.host_id;
          if (data.is_host !== undefined) this.isHost = data.is_host;

          // Kullanıcı katıldı/ayrıldı ses bildirimi
          if (this.soundEnabled && oldCount > 0) {
            if (
              data.type === "user_joined" &&
              data.user_id !== this.currentUserId
            ) {
              this.playJoinSound();
            } else if (data.type === "user_left") {
              this.playLeaveSound();
            }
          }
        };

        this.webrtc.onRemoteStream = (stream) => {
          this.remoteStream = stream;
          if (stream && this.$refs.remoteVideo) {
            this.$refs.remoteVideo.srcObject = stream;
          }
        };

        this.webrtc.onChatMessage = (msg) => {
          this.chatMessages.push(msg);
          // Başkasından gelen mesajlarda ses çal
          if (msg.user_id !== this.currentUserId && this.soundEnabled) {
            this.playNotificationSound();
          }
          this.$nextTick(() => {
            if (this.$refs.chatContainer) {
              this.$refs.chatContainer.scrollTop =
                this.$refs.chatContainer.scrollHeight;
            }
            if (this.$refs.mobileChatContainer) {
              this.$refs.mobileChatContainer.scrollTop =
                this.$refs.mobileChatContainer.scrollHeight;
            }
          });
        };

        this.webrtc.onConnectionStateChange = (state) => {
          this.connected = state === "connected" || state !== "disconnected";
        };

        // Presenter değişikliği callback
        this.webrtc.onPresenterChange = (
          presenterId,
          presenterName,
          shareType
        ) => {
          this.currentPresenterId = presenterId;
          this.currentPresenterName = presenterName;
          this.currentShareType = shareType;

          if (!presenterId) {
            // Kimse paylaşmıyor - remote stream'i temizle
            this.remoteStream = null;
            if (this.$refs.remoteVideo) {
              this.$refs.remoteVideo.srcObject = null;
            }
          }
        };

        // Viewer audio callback (host için)
        this.webrtc.onViewerAudio = (userId, username, stream) => {
          if (stream) {
            // Viewer'dan gelen sesi çal
            const audio = new Audio();
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.id = "viewer-audio-" + userId;
            document.body.appendChild(audio);
            console.log(`${username} mikrofon açtı`);
          } else {
            // Viewer mikrofonu kapattı
            const audio = document.getElementById("viewer-audio-" + userId);
            if (audio) {
              audio.srcObject = null;
              audio.remove();
            }
            console.log(`${username} mikrofon kapattı`);
          }
        };

        // Whiteboard callbacks
        this.webrtc.onWhiteboardDraw = (data) => {
          this.handleRemoteDraw(data);
        };

        this.webrtc.onWhiteboardClear = () => {
          this.handleRemoteClear();
        };

        this.webrtc.onWhiteboardStarted = (userId, username) => {
          if (userId !== this.currentUserId) {
            this.showWhiteboard = true;
            this.$nextTick(() => {
              this.initCanvas();
            });
          }
        };

        this.webrtc.onWhiteboardStopped = () => {
          this.showWhiteboard = false;
        };

        // Connect WebSocket
        try {
          await this.webrtc.connect();
          this.connected = true;
        } catch (e) {
          console.error("Connection failed:", e);
          alert("Bağlantı kurulamadı");
          window.location.href = "/dashboard";
        }
      },

      async loadRoomInfo() {
        try {
          const response = await Auth.fetchWithAuth(
            "/api/rooms/" + this.roomId
          );
          if (response && response.ok) {
            const room = await response.json();
            this.roomName = room.name;
            this.inviteCode = room.invite_code;
            this.hostId = room.host_id;
            this.isHost = room.host_id === this.currentUserId;
          }
        } catch (e) {
          console.error("Failed to load room:", e);
        }
      },

      async startScreenShare() {
        // Başka biri paylaşıyorsa engelle
        if (
          this.currentPresenterId &&
          !this.isScreenSharing &&
          !this.isCameraSharing
        ) {
          alert(
            this.currentPresenterName +
              " şu an paylaşım yapıyor. Lütfen bekleyin."
          );
          return;
        }

        try {
          const stream = await this.webrtc.startScreenShare();
          this.isScreenSharing = true;
          this.isCameraSharing = false;
          this.currentPresenterId = this.currentUserId;
          this.currentPresenterName = "Sen";
          this.currentShareType = "screen";
          if (this.$refs.localVideo) {
            this.$refs.localVideo.srcObject = stream;
          }
          this.startTimer();
        } catch (e) {
          console.error("Screen share failed:", e);
          if (e.message && e.message.includes("Başka biri")) {
            alert(e.message);
          } else if (e.name !== "NotAllowedError") {
            alert("Ekran paylaşımı başlatılamadı");
          }
        }
      },

      async startCameraShare() {
        // Başka biri paylaşıyorsa engelle
        if (
          this.currentPresenterId &&
          !this.isScreenSharing &&
          !this.isCameraSharing
        ) {
          alert(
            this.currentPresenterName +
              " şu an paylaşım yapıyor. Lütfen bekleyin."
          );
          return;
        }

        try {
          const stream = await this.webrtc.startCameraShare("user");
          this.isCameraSharing = true;
          this.isScreenSharing = false;
          this.currentPresenterId = this.currentUserId;
          this.currentPresenterName = "Sen";
          this.currentShareType = "camera";
          if (this.$refs.localVideo) {
            this.$refs.localVideo.srcObject = stream;
          }
          this.startTimer();
          this.showShareMenu = false;
        } catch (e) {
          console.error("Camera share failed:", e);
          if (e.message && e.message.includes("Başka biri")) {
            alert(e.message);
          } else if (e.name !== "NotAllowedError") {
            alert(
              "Kamera paylaşımı başlatılamadı. Kamera izni verildiğinden emin olun."
            );
          }
        }
      },

      async switchCamera() {
        if (!this.isCameraSharing) return;
        try {
          const stream = await this.webrtc.switchCamera();
          if (this.$refs.localVideo) {
            this.$refs.localVideo.srcObject = stream;
          }
        } catch (e) {
          console.error("Camera switch failed:", e);
          alert("Kamera değiştirilemedi");
        }
      },

      stopSharing() {
        if (this.isScreenSharing) {
          this.webrtc.stopScreenShare();
          this.isScreenSharing = false;
        } else if (this.isCameraSharing) {
          this.webrtc.stopCameraShare();
          this.isCameraSharing = false;
        }
        this.currentPresenterId = null;
        this.currentPresenterName = null;
        this.currentShareType = null;
        if (this.$refs.localVideo) {
          this.$refs.localVideo.srcObject = null;
        }
        this.stopTimer();
      },

      async toggleMic() {
        if (this.isMuted) {
          try {
            await this.webrtc.addAudioTrack();
            this.isMuted = false;
          } catch (e) {
            console.error("Mic error:", e);
            alert("Mikrofon erişimi sağlanamadı");
          }
        } else {
          this.isMuted = this.webrtc.toggleMute();
        }
      },

      sendMessage() {
        if (!this.newMessage.trim()) return;
        this.webrtc.sendChatMessage(this.newMessage.trim());
        this.newMessage = "";
      },

      kickUser(userId) {
        if (
          confirm("Bu kullanıcıyı odadan çıkarmak istediğinize emin misiniz?")
        ) {
          this.webrtc.kickUser(userId);
        }
      },

      copyInviteLink() {
        const link = this.publicUrl + "/join/" + this.inviteCode;
        navigator.clipboard.writeText(link);
        alert("Davet linki kopyalandı!");
      },

      leaveRoom() {
        if (confirm("Odadan ayrılmak istediğinize emin misiniz?")) {
          this.webrtc.disconnect();
          window.location.href = "/dashboard";
        }
      },

      endRoom() {
        if (
          confirm(
            "Odayı sonlandırmak istediğinize emin misiniz? Tüm katılımcılar çıkarılacak."
          )
        ) {
          this.webrtc.endRoom();
          setTimeout(() => {
            window.location.href = "/dashboard";
          }, 500);
        }
      },

      startTimer() {
        this.elapsedTime = 0;
        this.timerInterval = setInterval(() => {
          this.elapsedTime++;
        }, 1000);
      },

      stopTimer() {
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
          this.timerInterval = null;
        }
      },

      formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return [h, m, s].map((v) => v.toString().padStart(2, "0")).join(":");
      },

      formatMessageTime(timestamp) {
        if (!timestamp) return "";
        const date = new Date(timestamp);
        return date.toLocaleTimeString("tr-TR", {
          hour: "2-digit",
          minute: "2-digit",
        });
      },

      // Ses bildirimi oluştur
      createNotificationSound() {
        // Web Audio API ile basit bir beep sesi oluştur
        try {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          this.audioContext = audioContext;
        } catch (e) {
          console.warn("Audio context not supported");
        }
      },

      playNotificationSound() {
        if (!this.audioContext) return;
        try {
          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);

          oscillator.frequency.value = 800;
          oscillator.type = "sine";

          gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            this.audioContext.currentTime + 0.3
          );

          oscillator.start(this.audioContext.currentTime);
          oscillator.stop(this.audioContext.currentTime + 0.3);
        } catch (e) {
          console.warn("Could not play notification sound");
        }
      },

      // Kullanıcı katıldı sesi (yükselen iki nota)
      playJoinSound() {
        if (!this.audioContext) return;
        try {
          // İlk nota
          const osc1 = this.audioContext.createOscillator();
          const gain1 = this.audioContext.createGain();
          osc1.connect(gain1);
          gain1.connect(this.audioContext.destination);
          osc1.frequency.value = 523; // C5
          osc1.type = "sine";
          gain1.gain.setValueAtTime(0.25, this.audioContext.currentTime);
          gain1.gain.exponentialRampToValueAtTime(
            0.01,
            this.audioContext.currentTime + 0.15
          );
          osc1.start(this.audioContext.currentTime);
          osc1.stop(this.audioContext.currentTime + 0.15);

          // İkinci nota (daha yüksek)
          const osc2 = this.audioContext.createOscillator();
          const gain2 = this.audioContext.createGain();
          osc2.connect(gain2);
          gain2.connect(this.audioContext.destination);
          osc2.frequency.value = 659; // E5
          osc2.type = "sine";
          gain2.gain.setValueAtTime(0.25, this.audioContext.currentTime + 0.12);
          gain2.gain.exponentialRampToValueAtTime(
            0.01,
            this.audioContext.currentTime + 0.35
          );
          osc2.start(this.audioContext.currentTime + 0.12);
          osc2.stop(this.audioContext.currentTime + 0.35);
        } catch (e) {
          console.warn("Could not play join sound");
        }
      },

      // Kullanıcı ayrıldı sesi (alçalan iki nota)
      playLeaveSound() {
        if (!this.audioContext) return;
        try {
          // İlk nota (yüksek)
          const osc1 = this.audioContext.createOscillator();
          const gain1 = this.audioContext.createGain();
          osc1.connect(gain1);
          gain1.connect(this.audioContext.destination);
          osc1.frequency.value = 440; // A4
          osc1.type = "sine";
          gain1.gain.setValueAtTime(0.2, this.audioContext.currentTime);
          gain1.gain.exponentialRampToValueAtTime(
            0.01,
            this.audioContext.currentTime + 0.15
          );
          osc1.start(this.audioContext.currentTime);
          osc1.stop(this.audioContext.currentTime + 0.15);

          // İkinci nota (daha alçak)
          const osc2 = this.audioContext.createOscillator();
          const gain2 = this.audioContext.createGain();
          osc2.connect(gain2);
          gain2.connect(this.audioContext.destination);
          osc2.frequency.value = 330; // E4
          osc2.type = "sine";
          gain2.gain.setValueAtTime(0.2, this.audioContext.currentTime + 0.12);
          gain2.gain.exponentialRampToValueAtTime(
            0.01,
            this.audioContext.currentTime + 0.35
          );
          osc2.start(this.audioContext.currentTime + 0.12);
          osc2.stop(this.audioContext.currentTime + 0.35);
        } catch (e) {
          console.warn("Could not play leave sound");
        }
      },

      // Whiteboard fonksiyonları
      toggleWhiteboard() {
        this.showWhiteboard = !this.showWhiteboard;
        if (this.showWhiteboard) {
          this.$nextTick(() => {
            this.initCanvas();
          });
          // Diğer kullanıcılara whiteboard açıldığını bildir
          this.webrtc.send({ type: "whiteboard_started" });
        } else {
          this.webrtc.send({ type: "whiteboard_stopped" });
        }
      },

      initCanvas() {
        const canvas = this.$refs.whiteboardCanvas;
        if (!canvas) return;

        const container = canvas.parentElement;
        const dpr = window.devicePixelRatio || 1;

        // Canvas boyutlarını container'a göre ayarla
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";

        this.ctx = canvas.getContext("2d");
        this.ctx.scale(dpr, dpr);
        this.ctx.lineCap = "round";
        this.ctx.lineJoin = "round";
        this.ctx.fillStyle = "#1a2430";
        this.ctx.fillRect(0, 0, rect.width, rect.height);

        // Resize handler - debounced
        if (this.resizeHandler) {
          window.removeEventListener("resize", this.resizeHandler);
        }
        this.resizeHandler = this.debounce(() => {
          if (this.showWhiteboard && this.$refs.whiteboardCanvas) {
            const canvas = this.$refs.whiteboardCanvas;
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;

            // Mevcut çizimi kaydet
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCanvas.getContext("2d").drawImage(canvas, 0, 0);

            // Yeni boyutları ayarla
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + "px";
            canvas.style.height = rect.height + "px";

            this.ctx = canvas.getContext("2d");
            this.ctx.scale(dpr, dpr);
            this.ctx.lineCap = "round";
            this.ctx.lineJoin = "round";

            // Arka planı doldur
            this.ctx.fillStyle = "#1a2430";
            this.ctx.fillRect(0, 0, rect.width, rect.height);

            // Eski çizimi geri yükle (ölçekli)
            this.ctx.drawImage(tempCanvas, 0, 0, rect.width, rect.height);
          }
        }, 250);
        window.addEventListener("resize", this.resizeHandler);
      },

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      getCanvasCoords(e) {
        const canvas = this.$refs.whiteboardCanvas;
        const rect = canvas.getBoundingClientRect();
        let x, y;

        if (e.touches && e.touches.length > 0) {
          x = e.touches[0].clientX - rect.left;
          y = e.touches[0].clientY - rect.top;
        } else {
          x = e.clientX - rect.left;
          y = e.clientY - rect.top;
        }

        // Koordinatlar zaten CSS piksel cinsinden, dpr ölçekleme ctx.scale ile yapılıyor
        return { x, y };
      },

      startDrawing(e) {
        this.isDrawing = true;
        const coords = this.getCanvasCoords(e);
        this.lastX = coords.x;
        this.lastY = coords.y;
      },

      draw(e) {
        if (!this.isDrawing || !this.ctx) return;

        const coords = this.getCanvasCoords(e);

        this.ctx.beginPath();
        this.ctx.moveTo(this.lastX, this.lastY);
        this.ctx.lineTo(coords.x, coords.y);

        if (this.isEraser) {
          this.ctx.strokeStyle = "#1a2430";
          this.ctx.lineWidth = this.brushSize * 3;
        } else {
          this.ctx.strokeStyle = this.currentColor;
          this.ctx.lineWidth = this.brushSize;
        }

        this.ctx.stroke();

        // Çizimi diğer kullanıcılara gönder
        this.webrtc.send({
          type: "whiteboard_draw",
          fromX: this.lastX,
          fromY: this.lastY,
          toX: coords.x,
          toY: coords.y,
          color: this.isEraser ? "#1a2430" : this.currentColor,
          size: this.isEraser ? this.brushSize * 3 : this.brushSize,
        });

        this.lastX = coords.x;
        this.lastY = coords.y;
      },

      stopDrawing() {
        this.isDrawing = false;
      },

      clearCanvas() {
        if (!this.ctx) return;
        const canvas = this.$refs.whiteboardCanvas;
        this.ctx.fillStyle = "#1a2430";
        this.ctx.fillRect(0, 0, canvas.width, canvas.height);
        // Temizlemeyi diğer kullanıcılara bildir
        this.webrtc.send({ type: "whiteboard_clear" });
      },

      // Uzaktan gelen çizimi uygula
      handleRemoteDraw(data) {
        if (!this.ctx || !this.showWhiteboard) return;

        this.ctx.beginPath();
        this.ctx.moveTo(data.fromX, data.fromY);
        this.ctx.lineTo(data.toX, data.toY);
        this.ctx.strokeStyle = data.color;
        this.ctx.lineWidth = data.size;
        this.ctx.stroke();
      },

      handleRemoteClear() {
        if (!this.ctx || !this.showWhiteboard) return;
        const canvas = this.$refs.whiteboardCanvas;
        this.ctx.fillStyle = "#1a2430";
        this.ctx.fillRect(0, 0, canvas.width, canvas.height);
      },
    };
  }
</script>
{% endblock %}
