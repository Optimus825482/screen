{% extends "base.html" %} {% block title %}Yayın İzle - ScreenShare Pro{%
endblock %} {% block content %}
<div
  x-data="watchPage()"
  x-init="init()"
  x-cloak
  class="min-h-screen flex flex-col bg-background-dark"
>
  <!-- Header -->
  <header
    class="w-full border-b border-border-dark bg-surface-dark/80 backdrop-blur-sm sticky top-0 z-50"
  >
    <div class="px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/" class="flex items-center gap-2 text-white group">
          <div class="size-8 text-primary">
            <svg
              class="w-full h-full"
              fill="none"
              viewBox="0 0 48 48"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                clip-rule="evenodd"
                d="M39.475 21.6262C40.358 21.4363 40.6863 21.5589 40.7581 21.5934C40.7876 21.655 40.8547 21.857 40.8082 22.3336C40.7408 23.0255 40.4502 24.0046 39.8572 25.2301C38.6799 27.6631 36.5085 30.6631 33.5858 33.5858C30.6631 36.5085 27.6632 38.6799 25.2301 39.8572C24.0046 40.4502 23.0255 40.7407 22.3336 40.8082C21.8571 40.8547 21.6551 40.7875 21.5934 40.7581C21.5589 40.6863 21.4363 40.358 21.6262 39.475C21.8562 38.4054 22.4689 36.9657 23.5038 35.2817C24.7575 33.2417 26.5497 30.9744 28.7621 28.762C30.9744 26.5497 33.2417 24.7574 35.2817 23.5037C36.9657 22.4689 38.4054 21.8562 39.475 21.6262ZM4.41189 29.2403L18.7597 43.5881C19.8813 44.7097 21.4027 44.9179 22.7217 44.7893C24.0585 44.659 25.5148 44.1631 26.9723 43.4579C29.9052 42.0387 33.2618 39.5667 36.4142 36.4142C39.5667 33.2618 42.0387 29.9052 43.4579 26.9723C44.1631 25.5148 44.659 24.0585 44.7893 22.7217C44.9179 21.4027 44.7097 19.8813 43.5881 18.7597L29.2403 4.41187C27.8527 3.02428 25.8765 3.02573 24.2861 3.36776C22.6081 3.72863 20.7334 4.58419 18.8396 5.74801C16.4978 7.18716 13.9881 9.18353 11.5858 11.5858C9.18354 13.988 7.18717 16.4978 5.74802 18.8396C4.58421 20.7334 3.72865 22.6081 3.36778 24.2861C3.02574 25.8765 3.02429 27.8527 4.41189 29.2403Z"
                fill="currentColor"
                fill-rule="evenodd"
              ></path>
            </svg>
          </div>
        </a>
        <div class="h-6 w-px bg-border-dark"></div>
        <div class="flex items-center gap-2">
          <span
            class="text-white font-medium truncate max-w-[200px]"
            x-text="roomName || 'Yayın'"
          ></span>
          <span
            x-show="isConnected"
            class="flex items-center gap-1 text-xs text-green-400 bg-green-500/10 px-2 py-0.5 rounded-full"
          >
            <span
              class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"
            ></span>
            Canlı
          </span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <!-- Misafir adı -->
        <span class="text-sm text-text-secondary">
          <span class="material-symbols-outlined text-base align-middle mr-1"
            >person</span
          >
          <span x-text="guestName"></span>
        </span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main
    class="flex-grow flex flex-col lg:flex-row gap-4 p-4 max-w-[1800px] mx-auto w-full"
  >
    <!-- Video Area -->
    <div class="flex-grow flex flex-col gap-4">
      <!-- Video Container -->
      <div
        class="relative bg-black rounded-xl overflow-hidden aspect-video shadow-2xl border border-border-dark"
      >
        <!-- Remote Video (Host'un ekranı) -->
        <video
          x-ref="remoteVideo"
          autoplay
          playsinline
          class="w-full h-full object-contain"
          x-show="hasRemoteStream"
        ></video>

        <!-- Waiting State -->
        <div
          x-show="!hasRemoteStream"
          class="absolute inset-0 flex flex-col items-center justify-center bg-surface-dark"
        >
          <div class="text-center">
            <div
              class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center mx-auto mb-4"
            >
              <span
                class="material-symbols-outlined text-4xl text-primary animate-pulse"
                >live_tv</span
              >
            </div>
            <p class="text-white font-medium mb-2">Yayın Bekleniyor</p>
            <p class="text-text-secondary text-sm">
              Host ekran paylaşımını başlattığında yayın burada görünecek
            </p>
          </div>
        </div>

        <!-- Connection Status Overlay -->
        <div
          x-show="!isConnected"
          class="absolute inset-0 bg-black/80 flex items-center justify-center"
        >
          <div class="text-center">
            <svg
              class="animate-spin h-10 w-10 text-primary mx-auto mb-4"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <p class="text-white">Bağlanıyor...</p>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex items-center justify-center gap-3">
        <!-- Mikrofon Toggle -->
        <button
          @click="toggleMicrophone()"
          :class="isMicEnabled ? 'bg-green-500 hover:bg-green-600' : 'bg-surface-hover hover:bg-surface-dark'"
          class="flex items-center gap-2 px-4 py-2.5 rounded-lg text-white transition-all"
          :title="isMicEnabled ? 'Mikrofonu Kapat' : 'Mikrofonu Aç'"
        >
          <span
            class="material-symbols-outlined"
            x-text="isMicEnabled ? 'mic' : 'mic_off'"
          ></span>
          <span
            class="text-sm font-medium"
            x-text="isMicEnabled ? 'Mikrofon Açık' : 'Mikrofon Kapalı'"
          ></span>
        </button>

        <!-- Ses Seviyesi -->
        <div
          class="flex items-center gap-2 bg-surface-hover rounded-lg px-3 py-2"
        >
          <span class="material-symbols-outlined text-text-secondary"
            >volume_up</span
          >
          <input
            type="range"
            min="0"
            max="100"
            x-model="volume"
            @input="setVolume($event.target.value)"
            class="w-24 accent-primary"
          />
        </div>

        <!-- Fullscreen -->
        <button
          @click="toggleFullscreen()"
          class="p-2.5 rounded-lg bg-surface-hover hover:bg-surface-dark text-white transition-all"
          title="Tam Ekran"
        >
          <span class="material-symbols-outlined">fullscreen</span>
        </button>

        <!-- Ayrıl -->
        <button
          @click="leaveRoom()"
          class="flex items-center gap-2 px-4 py-2.5 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-400 transition-all"
        >
          <span class="material-symbols-outlined">logout</span>
          <span class="text-sm font-medium">Ayrıl</span>
        </button>
      </div>
    </div>

    <!-- Sidebar - Chat & Participants -->
    <div class="w-full lg:w-80 flex flex-col gap-4">
      <!-- Participants -->
      <div
        class="bg-surface-dark rounded-xl border border-border-dark overflow-hidden"
      >
        <div
          class="px-4 py-3 border-b border-border-dark flex items-center justify-between"
        >
          <h3 class="font-medium text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">group</span>
            Katılımcılar
          </h3>
          <span
            class="text-xs text-text-secondary bg-surface-hover px-2 py-0.5 rounded-full"
            x-text="participants.length"
          ></span>
        </div>
        <div class="p-2 max-h-40 overflow-y-auto">
          <template x-for="p in participants" :key="p.user_id">
            <div
              class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-surface-hover"
            >
              <div
                class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-medium"
                x-text="p.username.charAt(0).toUpperCase()"
              ></div>
              <div class="flex-grow min-w-0">
                <p class="text-sm text-white truncate" x-text="p.username"></p>
                <p
                  class="text-xs text-text-secondary"
                  x-text="p.is_guest ? 'Misafir' : (p.user_id === hostId ? 'Host' : 'Üye')"
                ></p>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Chat -->
      <div
        class="bg-surface-dark rounded-xl border border-border-dark overflow-hidden flex-grow flex flex-col min-h-[300px]"
      >
        <div class="px-4 py-3 border-b border-border-dark">
          <h3 class="font-medium text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">chat</span>
            Sohbet
          </h3>
        </div>

        <!-- Messages -->
        <div
          x-ref="chatMessages"
          class="flex-grow p-3 overflow-y-auto space-y-2"
        >
          <template x-for="(msg, idx) in chatMessages" :key="idx">
            <div class="flex gap-2">
              <div
                class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-primary text-xs font-medium flex-shrink-0"
                x-text="msg.username.charAt(0).toUpperCase()"
              ></div>
              <div class="min-w-0">
                <p
                  class="text-xs text-primary font-medium"
                  x-text="msg.username"
                ></p>
                <p
                  class="text-sm text-white break-words"
                  x-text="msg.message"
                ></p>
              </div>
            </div>
          </template>
          <p
            x-show="chatMessages.length === 0"
            class="text-center text-text-secondary text-sm py-4"
          >
            Henüz mesaj yok
          </p>
        </div>

        <!-- Input -->
        <div class="p-3 border-t border-border-dark">
          <form @submit.prevent="sendMessage()" class="flex gap-2">
            <input
              type="text"
              x-model="newMessage"
              placeholder="Mesaj yaz..."
              class="flex-grow px-3 py-2 rounded-lg bg-surface-hover border-0 text-white text-sm placeholder:text-slate-500 focus:ring-1 focus:ring-primary"
            />
            <button
              type="submit"
              class="p-2 rounded-lg bg-primary hover:bg-primary/90 text-white"
            >
              <span class="material-symbols-outlined">send</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  function watchPage() {
    return {
      roomId: "{{ room_id }}",
      publicUrl: "{{ public_url }}",
      guestName: "",
      guestToken: "",
      roomName: "",
      hostId: "",

      isConnected: false,
      hasRemoteStream: false,
      isMicEnabled: false,
      volume: 100,

      participants: [],
      chatMessages: [],
      newMessage: "",

      ws: null,
      peerConnection: null,
      audioPeerConnection: null,
      localAudioStream: null,

      iceConfig: {
        iceServers: [
          { urls: "stun:stun.relay.metered.ca:80" },
          {
            urls: "turn:standard.relay.metered.ca:80",
            username: "a00785389f1b29a83ff4325a",
            credential: "s5K3Fmbw9JY4snea",
          },
          {
            urls: "turn:standard.relay.metered.ca:80?transport=tcp",
            username: "a00785389f1b29a83ff4325a",
            credential: "s5K3Fmbw9JY4snea",
          },
          {
            urls: "turn:standard.relay.metered.ca:443",
            username: "a00785389f1b29a83ff4325a",
            credential: "s5K3Fmbw9JY4snea",
          },
          {
            urls: "turns:standard.relay.metered.ca:443?transport=tcp",
            username: "a00785389f1b29a83ff4325a",
            credential: "s5K3Fmbw9JY4snea",
          },
        ],
      },

      async init() {
        // Session'dan guest bilgilerini al
        this.guestToken = sessionStorage.getItem("guest_token");
        this.guestName = sessionStorage.getItem("guest_name") || "Misafir";
        const storedRoomId = sessionStorage.getItem("guest_room_id");

        if (!this.guestToken || storedRoomId !== this.roomId) {
          // Token yok veya farklı oda - join sayfasına yönlendir
          alert("Lütfen önce yayına katılın");
          window.location.href = "/";
          return;
        }

        // ICE config'i Metered API'den al
        await this.fetchIceConfig();

        // WebSocket bağlantısı
        await this.connectWebSocket();
      },

      async fetchIceConfig() {
        try {
          const response = await fetch(
            "https://erkan.metered.live/api/v1/turn/credentials?apiKey=a2278584590ae2fd0bf60959fe0fecb7e3a7"
          );
          if (response.ok) {
            const iceServers = await response.json();
            this.iceConfig = { iceServers };
          }
        } catch (e) {
          console.warn("ICE config fetch failed, using defaults");
        }
      },

      async connectWebSocket() {
        const wsProtocol =
          window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/room/${this.roomId}?guest_token=${this.guestToken}`;

        this.ws = new WebSocket(wsUrl);

        this.ws.onopen = () => {
          console.log("WebSocket connected");
          this.isConnected = true;
          this.startPing();
        };

        this.ws.onclose = (e) => {
          console.log("WebSocket closed:", e.code, e.reason);
          this.isConnected = false;
          if (e.code === 4001) {
            alert("Oturum sona erdi");
            window.location.href = "/";
          }
        };

        this.ws.onerror = (e) => {
          console.error("WebSocket error:", e);
        };

        this.ws.onmessage = (e) => this.handleMessage(JSON.parse(e.data));
      },

      startPing() {
        this.pingInterval = setInterval(() => {
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: "ping" }));
          }
        }, 30000);
      },

      send(data) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify(data));
        }
      },

      async handleMessage(data) {
        switch (data.type) {
          case "room_state":
            this.roomName = data.room_name;
            this.hostId = data.host_id;
            this.participants = data.participants;
            // Host'tan offer iste
            this.send({ type: "request_offer" });
            break;

          case "user_joined":
          case "user_left":
            this.participants = data.participants;
            break;

          case "offer":
            await this.handleOffer(data.from, data.sdp);
            break;

          case "ice_candidate":
            await this.handleIceCandidate(data.from, data.candidate);
            break;

          case "screen_share_started":
            this.send({ type: "request_offer" });
            break;

          case "screen_share_stopped":
            this.hasRemoteStream = false;
            if (this.$refs.remoteVideo) {
              this.$refs.remoteVideo.srcObject = null;
            }
            break;

          case "viewer_audio_answer":
            await this.handleAudioAnswer(data.sdp);
            break;

          case "chat":
            this.chatMessages.push(data);
            this.$nextTick(() => {
              if (this.$refs.chatMessages) {
                this.$refs.chatMessages.scrollTop =
                  this.$refs.chatMessages.scrollHeight;
              }
            });
            break;

          case "room_ended":
            alert("Yayın sona erdi");
            window.location.href = "/";
            break;

          case "kicked":
            alert(data.reason || "Yayından çıkarıldınız");
            window.location.href = "/";
            break;
        }
      },

      async handleOffer(fromUserId, sdp) {
        // Peer connection oluştur
        this.peerConnection = new RTCPeerConnection(this.iceConfig);

        this.peerConnection.ontrack = (event) => {
          console.log("Remote track received");
          if (this.$refs.remoteVideo) {
            this.$refs.remoteVideo.srcObject = event.streams[0];
            this.hasRemoteStream = true;
          }
        };

        this.peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            this.send({
              type: "ice_candidate",
              target: fromUserId,
              candidate: event.candidate,
            });
          }
        };

        await this.peerConnection.setRemoteDescription(
          new RTCSessionDescription(sdp)
        );
        const answer = await this.peerConnection.createAnswer();
        await this.peerConnection.setLocalDescription(answer);

        this.send({
          type: "answer",
          target: fromUserId,
          sdp: this.peerConnection.localDescription,
        });
      },

      async handleIceCandidate(fromUserId, candidate) {
        if (!candidate) return;

        // Host'tan gelen ICE candidate - video peer connection için
        if (fromUserId === this.hostId && this.peerConnection) {
          try {
            await this.peerConnection.addIceCandidate(
              new RTCIceCandidate(candidate)
            );
          } catch (e) {
            console.warn("Video ICE candidate error:", e);
          }
        }

        // Audio peer connection için de kontrol et
        if (fromUserId === this.hostId && this.audioPeerConnection) {
          try {
            await this.audioPeerConnection.addIceCandidate(
              new RTCIceCandidate(candidate)
            );
          } catch (e) {
            console.warn("Audio ICE candidate error:", e);
          }
        }
      },

      async toggleMicrophone() {
        if (this.isMicEnabled) {
          // Mikrofonu kapat
          console.log("Mikrofon kapatılıyor...");
          if (this.localAudioStream) {
            this.localAudioStream.getTracks().forEach((t) => t.stop());
            this.localAudioStream = null;
          }
          if (this.audioPeerConnection) {
            this.audioPeerConnection.close();
            this.audioPeerConnection = null;
          }
          this.isMicEnabled = false;
          this.send({ type: "viewer_audio_stopped" });
        } else {
          // Mikrofonu aç
          try {
            console.log("Mikrofon açılıyor...");
            this.localAudioStream = await navigator.mediaDevices.getUserMedia({
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
              },
            });

            console.log(
              "Mikrofon erişimi sağlandı, peer connection oluşturuluyor..."
            );

            // Audio için ayrı peer connection
            this.audioPeerConnection = new RTCPeerConnection(this.iceConfig);

            this.localAudioStream.getTracks().forEach((track) => {
              console.log("Audio track ekleniyor:", track.kind);
              this.audioPeerConnection.addTrack(track, this.localAudioStream);
            });

            this.audioPeerConnection.onicecandidate = (event) => {
              if (event.candidate) {
                console.log("Audio ICE candidate gönderiliyor host'a");
                this.send({
                  type: "ice_candidate",
                  target: this.hostId,
                  candidate: event.candidate,
                });
              }
            };

            this.audioPeerConnection.onconnectionstatechange = () => {
              console.log(
                "Audio peer connection state:",
                this.audioPeerConnection.connectionState
              );
            };

            this.audioPeerConnection.oniceconnectionstatechange = () => {
              console.log(
                "Audio ICE connection state:",
                this.audioPeerConnection.iceConnectionState
              );
            };

            const offer = await this.audioPeerConnection.createOffer();
            await this.audioPeerConnection.setLocalDescription(offer);

            console.log("Audio offer gönderiliyor host'a...");

            this.send({
              type: "viewer_audio_offer",
              sdp: this.audioPeerConnection.localDescription,
            });

            this.isMicEnabled = true;
          } catch (e) {
            console.error("Mikrofon erişim hatası:", e);
            alert("Mikrofon erişimi reddedildi: " + e.message);
          }
        }
      },

      async handleAudioAnswer(sdp) {
        console.log("Audio answer alındı host'tan");
        if (this.audioPeerConnection) {
          try {
            await this.audioPeerConnection.setRemoteDescription(
              new RTCSessionDescription(sdp)
            );
            console.log("Audio remote description set edildi");
          } catch (e) {
            console.error("Audio answer set error:", e);
          }
        }
      },

      setVolume(value) {
        if (this.$refs.remoteVideo) {
          this.$refs.remoteVideo.volume = value / 100;
        }
      },

      toggleFullscreen() {
        const video = this.$refs.remoteVideo;
        if (video) {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            video.requestFullscreen();
          }
        }
      },

      sendMessage() {
        if (!this.newMessage.trim()) return;
        this.send({
          type: "chat",
          message: this.newMessage.trim(),
          timestamp: new Date().toISOString(),
        });
        this.newMessage = "";
      },

      leaveRoom() {
        if (confirm("Yayından ayrılmak istediğinize emin misiniz?")) {
          sessionStorage.removeItem("guest_token");
          sessionStorage.removeItem("guest_name");
          sessionStorage.removeItem("guest_room_id");
          window.location.href = "/";
        }
      },
    };
  }
</script>
{% endblock %}
